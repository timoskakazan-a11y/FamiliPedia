<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FamiliPedia ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞—Ç–µ–π</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .prose h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.75em; }
  </style>
  <script type="importmap">
    {
      "imports": {
        "marked": "https://esm.sh/marked@^12.0.2",
        "dompurify": "https://esm.sh/dompurify@^3.1.2"
      }
    }
  </script>
  <script>
    // –í–ê–® –¢–û–ö–ï–ù –î–õ–Ø –ê–í–¢–û–ö–û–ú–ò–¢–û–í: –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
    // –ü—Ä–∏–º–µ—Ä: const GITHUB_TOKEN = 'github_pat_...';
    // –í–ù–ò–ú–ê–ù–ò–ï: –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –ø—É–±–ª–∏—á–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
    const GITHUB_TOKEN = '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';
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl">üìö</div>
        <div>
          <h1 class="text-xl font-semibold">FamiliPedia ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ç–∞—Ç–µ–π</h1>
          <p class="text-sm text-gray-500">–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –¥–ª—è `data.js`</p>
        </div>
      </div>
      <nav class="text-sm">
        <a href="./index.html" class="text-blue-600 hover:underline">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–∞–π—Ç—É</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
      <!-- Form -->
      <section class="xl:col-span-2 space-y-6">
        <div class="bg-white shadow-sm border border-gray-200 rounded-xl">
          <div class="p-4 border-b border-gray-200 flex flex-wrap items-center gap-3">
            <label class="text-sm text-gray-600">–¢–∏–ø —Å—Ç–∞—Ç—å–∏</label>
            <select id="type" class="px-3 py-2 border rounded-md">
              <option value="relative">–†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫</option>
              <option value="event">–°–æ–±—ã—Ç–∏–µ</option>
              <option value="resource">–†–µ—Å—É—Ä—Å</option>
            </select>
            <div class="ml-auto flex items-center gap-2 text-sm text-gray-500">
              <button id="gen-id" class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 border">–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è ID</button>
              <span class="hidden md:inline">(–∏—â–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π ID)</span>
            </div>
          </div>
          <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">ID (—á–∏—Å–ª–æ)</label>
              <input id="id" type="number" min="1" class="w-full px-3 py-2 border rounded-md" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 6" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input id="name" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="–ò–º—è / –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è / –†–µ—Å—É—Ä—Å" />
            </div>
            <div class="type-relative">
              <label class="block text-sm text-gray-600 mb-1">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
              <input id="birthDate" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 –æ–∫—Ç—è–±—Ä—è 1986 –≥. –∏–ª–∏ October 5, 1986" />
            </div>
            <div class="type-relative">
              <label class="block text-sm text-gray-600 mb-1">–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏</label>
              <input id="deathDate" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –∂–∏–≤" />
            </div>
            <div class="type-event hidden">
              <label class="block text-sm text-gray-600 mb-1">–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è</label>
              <input id="date" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 12 –º–∞—è 1995 –≥." />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-600 mb-1">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
              <input id="imageUrl" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="https://..." />
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-600 mb-1">–¢–µ–∫—Å—Ç (Markdown)</label>
              <textarea id="content" rows="10" class="w-full px-3 py-2 border rounded-md font-mono" placeholder="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è [—Å—Å—ã–ª–∫–∏](https://example.com), –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤–∏–¥–∞ [—Ç–µ–∫—Å—Ç](#rel-1) –∏ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Å–Ω–æ—Å–∫–∏: [^—Å–ª–æ–≤–æ:–æ–ø–∏—Å–∞–Ω–∏–µ]"></textarea>
            </div>
          </div>
        </div>

        <!-- Details builder -->
        <div class="bg-white shadow-sm border border-gray-200 rounded-xl">
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="font-semibold">–ò–Ω—Ñ–æ–±–æ–∫—Å ‚Äî –¥–µ—Ç–∞–ª–∏</h2>
            <div class="text-sm text-gray-500">–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–∞—Ä—ã –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–ø–∏—Å–∫–∏</div>
          </div>
          <div id="details-list" class="p-4 space-y-4"></div>
          <div class="p-4 border-t border-gray-200">
            <button id="add-detail" class="px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
          </div>
        </div>

        <!-- Optional banners -->
        <div class="bg-white shadow-sm border border-gray-200 rounded-xl">
          <div class="p-4 border-b border-gray-200">
            <h2 class="font-semibold">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h2>
          </div>
          <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (lockReason)</label>
              <input id="lockReason" type="text" class="w-full px-3 py-2 border rounded-md" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">–ó–∞–º–µ—Ç–∫–∞ –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (editingNotice)</label>
              <input id="editingNotice" type="text" class="w-full px-3 py-2 border rounded-md" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">–ë–∞–Ω–Ω–µ—Ä –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç–∏ (neutralityBanner)</label>
              <input id="neutralityBanner" type="text" class="w-full px-3 py-2 border rounded-md" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">–ë–∞–Ω–Ω–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ (unverifiedBanner)</label>
              <input id="unverifiedBanner" type="text" class="w-full px-3 py-2 border rounded-md" />
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          <button id="copy-json" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç</button>
          <button id="download-json" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-black">–°–∫–∞—á–∞—Ç—å .json</button>
          <span class="text-sm text-gray-500">–í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–∞—Å—Å–∏–≤ –≤ `data.js`</span>
        </div>

        <!-- GitHub commit -->
        <div class="bg-white shadow-sm border border-gray-200 rounded-xl mt-6">
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="font-semibold">–ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ GitHub (–∞–≤—Ç–æ‚Äë–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ data.js)</h2>
            <span class="text-xs text-gray-500">–¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ</span>
          </div>
          <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">GitHub Token</label>
              <input id="gh-token" type="password" class="w-full px-3 py-2 border rounded-md" placeholder="github_pat_..." />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">–í–µ—Ç–∫–∞</label>
              <input id="gh-branch" type="text" class="w-full px-3 py-2 border rounded-md" value="main" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">–í–ª–∞–¥–µ–ª–µ—Ü</label>
              <input id="gh-owner" type="text" class="w-full px-3 py-2 border rounded-md" value="timoskakazan-a11y" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</label>
              <input id="gh-repo" type="text" class="w-full px-3 py-2 border rounded-md" value="FamiliPedia" />
            </div>
            <div class="md:col-span-2 flex items-center gap-3">
              <button id="save-github" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ data.js</button>
              <label class="text-xs text-gray-500"><input id="save-token" type="checkbox" class="mr-1">–ó–∞–ø–æ–º–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ</label>
              <div id="gh-status" class="text-sm text-gray-600"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Preview / Output -->
      <aside class="space-y-6">
        <div class="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="font-semibold">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä Markdown</h2>
            <span class="text-xs text-gray-500">–°–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML</span>
          </div>
          <div id="preview" class="p-4 prose max-w-none"></div>
        </div>

        <div class="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="font-semibold">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç</h2>
            <span class="text-xs text-gray-500">–§–æ—Ä–º–∞—Ç JavaScript</span>
          </div>
          <pre id="result" class="p-4 overflow-x-auto text-sm bg-gray-50"><code></code></pre>
        </div>
      </aside>
    </div>
  </main>

  <script type="module">
    import { marked } from 'marked';
    import DOMPurify from 'dompurify';
    import { relativesData, eventsData, resourcesData } from './data.js';

    const els = {
      type: document.getElementById('type'),
      id: document.getElementById('id'),
      name: document.getElementById('name'),
      birthDate: document.getElementById('birthDate'),
      deathDate: document.getElementById('deathDate'),
      date: document.getElementById('date'),
      imageUrl: document.getElementById('imageUrl'),
      content: document.getElementById('content'),
      lockReason: document.getElementById('lockReason'),
      editingNotice: document.getElementById('editingNotice'),
      neutralityBanner: document.getElementById('neutralityBanner'),
      unverifiedBanner: document.getElementById('unverifiedBanner'),
      genId: document.getElementById('gen-id'),
      detailsList: document.getElementById('details-list'),
      addDetail: document.getElementById('add-detail'),
      preview: document.getElementById('preview'),
      result: document.getElementById('result'),
      copyJson: document.getElementById('copy-json'),
      downloadJson: document.getElementById('download-json'),
      ghToken: document.getElementById('gh-token'),
      ghOwner: document.getElementById('gh-owner'),
      ghRepo: document.getElementById('gh-repo'),
      ghBranch: document.getElementById('gh-branch'),
      saveGithub: document.getElementById('save-github'),
      saveToken: document.getElementById('save-token'),
      ghStatus: document.getElementById('gh-status'),
    };

    const allItems = [
      ...relativesData.map(x => ({ id: `rel-${x.id}`, name: x.name, type: 'relative' })),
      ...eventsData.map(x => ({ id: `evt-${x.id}`, name: x.name, type: 'event' })),
      ...resourcesData.map(x => ({ id: `res-${x.id}`, name: x.name, type: 'resource' })),
    ];

    const state = {
      type: 'relative',
      details: [], // array of {key, mode, value}
    };

    marked.setOptions({ gfm: true, breaks: true });

    function nextIdFor(type) {
      const arr = type === 'relative' ? relativesData : type === 'event' ? eventsData : resourcesData;
      const nums = arr.map(x => Number(x.id)).filter(n => !Number.isNaN(n));
      const max = nums.length ? Math.max(...nums) : 0;
      return String(max + 1);
    }

    function toggleTypeUI() {
      const isRel = state.type === 'relative';
      const isEvt = state.type === 'event';
      document.querySelectorAll('.type-relative').forEach(el => el.classList.toggle('hidden', !isRel));
      document.querySelectorAll('.type-event').forEach(el => el.classList.toggle('hidden', !isEvt));
    }

    function addDetailRow(prefill = {}) {
      const row = document.createElement('div');
      row.className = 'p-3 border rounded-lg';
      row.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-start">
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-600 mb-1">–ö–ª—é—á</label>
            <input type="text" class="w-full px-2 py-1.5 border rounded" value="${prefill.key ?? ''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–æ–¥–∏–ª—Å—è" />
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">–¢–∏–ø –∑–Ω–∞—á–µ–Ω–∏—è</label>
            <select class="w-full px-2 py-1.5 border rounded">
              <option value="text" ${prefill.mode === 'text' || !prefill.mode ? 'selected' : ''}>–¢–µ–∫—Å—Ç</option>
              <option value="list" ${prefill.mode === 'list' ? 'selected' : ''}>–°–ø–∏—Å–æ–∫ (–ø–æ —Å—Ç—Ä–æ–∫–∞–º)</option>
              <option value="relations" ${prefill.mode === 'relations' ? 'selected' : ''}>–°–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—Ç–∞—Ç—å–∏</option>
              <option value="education" ${prefill.mode === 'education' ? 'selected' : ''}>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
              <option value="work" ${prefill.mode === 'work' ? 'selected' : ''}>–ú–µ—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã</option>
            </select>
          </div>
          <div class="md:col-span-3 value-holder"></div>
          <div class="flex items-end justify-end">
            <button class="remove px-2.5 py-1.5 bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;

      const keyEl = row.querySelector('input[type="text"]');
      const modeEl = row.querySelector('select');
      const holder = row.querySelector('.value-holder');

      function renderValueEditor() {
        const mode = modeEl.value;
        if (mode === 'text') {
          holder.innerHTML = `<label class="block text-xs text-gray-600 mb-1">–ó–Ω–∞—á–µ–Ω–∏–µ</label><input class="w-full px-2 py-1.5 border rounded" value="${prefill.value ?? ''}">`;
        } else if (mode === 'list') {
          const val = Array.isArray(prefill.value) ? prefill.value.join('\n') : (prefill.value ?? '');
          holder.innerHTML = `<label class=\"block text-xs text-gray-600 mb-1\">–≠–ª–µ–º–µ–Ω—Ç—ã (–ø–æ —Å—Ç—Ä–æ–∫–∞–º)</label><textarea rows=\"4\" class=\"w-full px-2 py-1.5 border rounded font-mono\">${val}</textarea>`;
        } else if (mode === 'relations') {
          const selectedIds = (Array.isArray(prefill.value) ? prefill.value : []).map(v => v.id);
          const options = allItems.map(it => `<option value="${it.id}" ${selectedIds.includes(it.id) ? 'selected' : ''}>${it.name} (${it.id})</option>`).join('');
          holder.innerHTML = `
            <label class="block text-xs text-gray-600 mb-1">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å–∏ (Ctrl/Cmd + –∫–ª–∏–∫)</label>
            <select multiple size="6" class="w-full px-2 py-1.5 border rounded">${options}</select>
          `;
        } else if (mode === 'education') {
          // rows of {name, specialty, status}
          const list = Array.isArray(prefill.value) ? prefill.value : [];
          holder.innerHTML = `
            <div class="space-y-2">
              <div class="flex items-center justify-between"><label class="text-xs text-gray-600">–°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π</label><button class="add-edu px-2 py-1 border rounded bg-gray-100">–î–æ–±–∞–≤–∏—Ç—å</button></div>
              <div class="edu-list space-y-2"></div>
            </div>
          `;
          const listEl = holder.querySelector('.edu-list');
          function renderRows() {
            listEl.innerHTML = '';
            list.forEach((item, idx) => {
              const row = document.createElement('div');
              row.className = 'grid grid-cols-1 md:grid-cols-3 gap-2';
              row.innerHTML = `
                <input class="px-2 py-1.5 border rounded" placeholder="–í–£–ó" value="${item.name ?? ''}">
                <input class="px-2 py-1.5 border rounded" placeholder="–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å" value="${item.specialty ?? ''}">
                <div class="flex gap-2">
                  <input class="flex-1 px-2 py-1.5 border rounded" placeholder="–°—Ç–∞—Ç—É—Å" value="${item.status ?? ''}">
                  <button class="del px-2 border rounded bg-red-50 text-red-700">√ó</button>
                </div>
              `;
              row.querySelector('.del').addEventListener('click', () => { list.splice(idx,1); renderRows(); update(); });
              const [nameEl, specEl, statusEl] = row.querySelectorAll('input');
              nameEl.addEventListener('input', () => { item.name = nameEl.value; update(); });
              specEl.addEventListener('input', () => { item.specialty = specEl.value; update(); });
              statusEl.addEventListener('input', () => { item.status = statusEl.value; update(); });
              listEl.appendChild(row);
            });
          }
          renderRows();
          holder.querySelector('.add-edu').addEventListener('click', () => { list.push({ name: '', specialty: '', status: '' }); renderRows(); update(); });
          holder._getValue = () => list.slice();
          return;
        } else if (mode === 'work') {
          // rows of {name, position, period}
          const list = Array.isArray(prefill.value) ? prefill.value : [];
          holder.innerHTML = `
            <div class="space-y-2">
              <div class="flex items-center justify-between"><label class="text-xs text-gray-600">–ú–µ—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã</label><button class="add-work px-2 py-1 border rounded bg-gray-100">–î–æ–±–∞–≤–∏—Ç—å</button></div>
              <div class="work-list space-y-2"></div>
            </div>
          `;
          const listEl = holder.querySelector('.work-list');
          function renderRows() {
            listEl.innerHTML = '';
            list.forEach((item, idx) => {
              const row = document.createElement('div');
              row.className = 'grid grid-cols-1 md:grid-cols-3 gap-2';
              row.innerHTML = `
                <input class="px-2 py-1.5 border rounded" placeholder="–ö–æ–º–ø–∞–Ω–∏—è" value="${item.name ?? ''}">
                <input class="px-2 py-1.5 border rounded" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å" value="${item.position ?? ''}">
                <div class="flex gap-2">
                  <input class="flex-1 px-2 py-1.5 border rounded" placeholder="–ü–µ—Ä–∏–æ–¥" value="${item.period ?? ''}">
                  <button class="del px-2 border rounded bg-red-50 text-red-700">√ó</button>
                </div>
              `;
              row.querySelector('.del').addEventListener('click', () => { list.splice(idx,1); renderRows(); update(); });
              const [nameEl, posEl, perEl] = row.querySelectorAll('input');
              nameEl.addEventListener('input', () => { item.name = nameEl.value; update(); });
              posEl.addEventListener('input', () => { item.position = posEl.value; update(); });
              perEl.addEventListener('input', () => { item.period = perEl.value; update(); });
              listEl.appendChild(row);
            });
          }
          renderRows();
          holder.querySelector('.add-work').addEventListener('click', () => { list.push({ name: '', position: '', period: '' }); renderRows(); update(); });
          holder._getValue = () => list.slice();
          return;
        }

        holder._getValue = () => {
          const mode = modeEl.value;
          if (mode === 'text') return holder.querySelector('input').value;
          if (mode === 'list') return holder.querySelector('textarea').value.split('\n').map(s => s.trim()).filter(Boolean);
          if (mode === 'relations') {
            const sel = holder.querySelector('select');
            return Array.from(sel.selectedOptions).map(o => {
              const item = allItems.find(i => i.id === o.value);
              return item ? { name: item.name, id: item.id } : { name: o.textContent, id: o.value };
            });
          }
          return null;
        };
      }

      renderValueEditor();
      modeEl.addEventListener('change', () => { renderValueEditor(); update(); });
      row.querySelector('.remove').addEventListener('click', () => { row.remove(); update(); });
      row.addEventListener('input', () => update());

      els.detailsList.appendChild(row);
    }

    function collectDetailsObject() {
      const obj = {};
      els.detailsList.querySelectorAll('.p-3.border.rounded-lg').forEach(row => {
        const key = row.querySelector('input[type="text"]').value.trim();
        const mode = row.querySelector('select').value;
        const holder = row.querySelector('.value-holder');
        if (!key) return;
        const value = holder._getValue ? holder._getValue() : null;
        obj[key] = value;
      });
      return obj;
    }

    function buildObject() {
      const type = state.type;
      const id = String(els.id.value || '').trim();
      const base = {
        id,
        name: String(els.name.value || '').trim(),
        imageUrl: String(els.imageUrl.value || '').trim(),
        content: String(els.content.value || '').trim(),
      };
      const banners = {
        lockReason: String(els.lockReason.value || '').trim(),
        editingNotice: String(els.editingNotice.value || '').trim(),
        neutralityBanner: String(els.neutralityBanner.value || '').trim(),
        unverifiedBanner: String(els.unverifiedBanner.value || '').trim(),
      };
      const details = collectDetailsObject();

      if (type === 'relative') {
        return {
          ...base,
          birthDate: String(els.birthDate.value || '').trim(),
          deathDate: String(els.deathDate.value || '').trim(),
          details,
          ...banners,
        };
      }
      if (type === 'event') {
        return {
          ...base,
          date: String(els.date.value || '').trim(),
          details,
          ...banners,
        };
      }
      // resource
      return {
        ...base,
        details,
      };
    }

    function jsStringify(obj) {
      // Stringify to a pretty JS object literal (not JSON quotes for keys)
      const json = JSON.stringify(obj, (k, v) => v, 2);
      // Make it look like data.js style by unquoting simple keys
      return json
        .replace(/\"(\w+)\":/g, '$1:')
        .replace(/\\n/g, '\n');
    }

    function renderOutput() {
      const obj = buildObject();
      const code = jsStringify(obj);
      els.result.querySelector('code').textContent = code;

      const html = marked.parse(obj.content || '');
      els.preview.innerHTML = DOMPurify.sanitize(html);
    }

    function update() { renderOutput(); }

    // Events
    els.type.addEventListener('change', () => {
      state.type = els.type.value;
      toggleTypeUI();
      els.id.value = nextIdFor(state.type);
      renderOutput();
    });
    els.genId.addEventListener('click', () => { els.id.value = nextIdFor(state.type); renderOutput(); });

    [els.id, els.name, els.birthDate, els.deathDate, els.date, els.imageUrl, els.content, els.lockReason, els.editingNotice, els.neutralityBanner, els.unverifiedBanner]
      .forEach(el => el && el.addEventListener('input', update));

    els.addDetail.addEventListener('click', () => addDetailRow());

    els.copyJson.addEventListener('click', async () => {
      const text = els.result.querySelector('code').textContent;
      await navigator.clipboard.writeText(text);
      els.copyJson.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(() => (els.copyJson.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç'), 1200);
    });

    els.downloadJson.addEventListener('click', () => {
      const obj = buildObject();
      const blob = new Blob([jsStringify(obj)], { type: 'application/json;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const fname = `${state.type}-${obj.id || 'new'}.json`;
      a.download = fname;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // --- GitHub integration: append to data.js and commit via REST API ---
    function loadSavedToken() {
      try {
        const saved = localStorage.getItem('familipedia_gh_token');
        if (saved) { els.ghToken.value = saved; els.saveToken.checked = true; }
      } catch {}
    }
    function saveTokenIfNeeded() {
      try {
        if (els.saveToken.checked) localStorage.setItem('familipedia_gh_token', els.ghToken.value || '');
        else localStorage.removeItem('familipedia_gh_token');
      } catch {}
    }

    function getAsciiToken() {
      let token = (els.ghToken.value || GITHUB_TOKEN || '').trim();
      if (!token) return '';
      // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã/–ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫ –∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
      token = token.replace(/\s+/g, '');
      // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ (—Ñ–æ—Ä–º–∞—Ç github_pat_...)
      const cleaned = token.replace(/[^A-Za-z0-9_]/g, '');
      return cleaned;
    }

    async function githubRequest(path, method = 'GET', bodyObj) {
      const token = getAsciiToken();
      if (!token) throw new Error('–ù–µ —É–∫–∞–∑–∞–Ω GitHub —Ç–æ–∫–µ–Ω');
      const headers = new Headers([
        ['Authorization', `token ${token}`],
        ['Accept', 'application/vnd.github+json'],
      ]);
      const opts = { method, headers };
      if (bodyObj) opts.body = JSON.stringify(bodyObj);
      const res = await fetch(`https://api.github.com${path}`, opts);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`GitHub API ${res.status}: ${text}`);
      }
      return res.json();
    }

    function objectToJsLiteral(obj) {
      return jsStringify(obj);
    }

    function buildInsertSnippet(type, objLiteral) {
      // Generates code to push into correct array
      return `\n    ${objLiteral},\n`;
    }

    async function commitNewEntry() {
      els.ghStatus.textContent = '–ü–æ–ª—É—á–∞—é —Ç–µ–∫—É—â–∏–π data.js...';
      const owner = els.ghOwner.value.trim();
      const repo = els.ghRepo.value.trim();
      const branch = els.ghBranch.value.trim() || 'main';

      // 1) Read current file
      const contentResp = await githubRequest(`/repos/${owner}/${repo}/contents/data.js?ref=${encodeURIComponent(branch)}`);
      const sha = contentResp.sha;
      const content = typeof atob === 'function'
        ? atob(contentResp.content.replace(/\n/g, ''))
        : Buffer.from(contentResp.content, 'base64').toString('utf-8');

      // 2) Prepare new object
      const type = state.type;
      const obj = buildObject();
      if (!obj.id || !obj.name) throw new Error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º ID –∏ –ù–∞–∑–≤–∞–Ω–∏–µ');
      const literal = objectToJsLiteral(obj);

      // 3) Insert into correct array by finding marker
      let newContent = content;
      const marker = type === 'relative' ? 'const relativesData = [' : type === 'event' ? 'const eventsData = [' : 'const resourcesData = [';
      const idx = newContent.indexOf(marker);
      if (idx === -1) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω —Ü–µ–ª–µ–≤–æ–π –º–∞—Å—Å–∏–≤ –≤ data.js');
      const insertPos = newContent.indexOf('];', idx);
      if (insertPos === -1) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤—Å—Ç–∞–≤–∫–∏');
      const before = newContent.slice(0, insertPos);
      const after = newContent.slice(insertPos);
      newContent = before + buildInsertSnippet(type, literal) + after;

      // 4) Encode and commit
      els.ghStatus.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–º–º–∏—Ç...';
      const b64 = typeof btoa === 'function'
        ? btoa(unescape(encodeURIComponent(newContent)))
        : Buffer.from(newContent, 'utf-8').toString('base64');
      const message = `Add ${type} ${obj.name} (id ${obj.id}) via editor`;
      await githubRequest(`/repos/${owner}/${repo}/contents/data.js`, 'PUT', {
        message,
        content: b64,
        sha,
        branch,
      });
      els.ghStatus.textContent = '–ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –¥–µ–ø–ª–æ–π.';
    }

    els.saveGithub.addEventListener('click', async () => {
      saveTokenIfNeeded();
      els.saveGithub.disabled = true;
      els.ghStatus.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      try {
        await commitNewEntry();
      } catch (e) {
        console.error(e);
        els.ghStatus.textContent = '–û—à–∏–±–∫–∞: ' + (e?.message || e);
      } finally {
        els.saveGithub.disabled = false;
      }
    });

    // Defaults
    els.type.value = 'relative';
    state.type = 'relative';
    toggleTypeUI();
    els.id.value = nextIdFor('relative');
    addDetailRow({ key: '–†–æ–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏', mode: 'list', value: [] });
    addDetailRow({ key: '–†–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏', mode: 'relations', value: [] });
    renderOutput();
    loadSavedToken();
  </script>
</body>
</html>




